---
title: "IPNT"
author: "Yuxuan Gao"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 3
    number_sections: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
  pdf_document:
    toc: yes
    toc_depth: '3'
editor_options: 
  chunk_output_type: console
---
This is the code organized and written by **Yuxuan Gao** in 2023 for the **IPNT** project initiated by Professor Lingli Liu and Yuxuan Gao.

**ATTENTIONS: There might be some typos and small mistakes in descriptions.** 

Email: yuxuangao@ibcas.ac.cn

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 16px;
      font-family: "Times New Roman"
  }
td {  /* Table  */
  font-size: 14px;
}
h1.title {
  font-size: 34px;
  color: Black;
  font-family: "Arial";
}
h1 { /* Header 1 */
  font-size: 26px;
  color: DarkBlue;
  font-family: "Arial";
}
h2 { /* Header 2 */
    font-size: 22px;
    font-family: "Arial";
    color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Arial";
  color: DarkBlue;
}

h4 { /* Header 4 */
  font-size: 16px;
  font-family: "Arial";
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 12px;
}
</style>
```

# **Key Variables**

**Fixed effects**

-   **TransferRatio:** Percentage (%). Fitting Beta distribution. Receiver 15N content divided by Receiver 15N content plus Donor 15N content (mg).
-   **NDFT:** Percentage (%). Fitting Beta distribution. Nitrogen derived from transfer. Ntransferred divided by Receiver Total N content (mg).
-   **Ntransferred:** Real number. In milligrams (mg plant-1). TransferRatio multiply Donor Total N content (mg) / (1 âˆ’ TransferRatio).
-   **Mycor:** 1 vs. 0. Whether Donor and Receiver plants could be connected by **Mycorrhizal Networks (MNs)**.
-   **NoduleExist:** 1 vs. 0. Whether Donor are Associated with **Symbiotic Nitrogen-fixing Bacteria** (Rhizobia or Frankia).
-   **Symbiosis:** A,B,C,D: None, MN, NFB, MN+NFB
-   **PD:** Phylogenetic distances (Myr) between Donor and Receiver Species.
-   **SourceSinkTN:**  Plant N pool differences. Donor N amount divided by Receiver N amount.
-   **SourceSinkTNC:** Plant N conc differences. Donor N concentration divided by Receiver N concentration.
-   **K:** Mycorrhizal colonization rate (MCR) differences. Donor Mycorrhizal colonization rate divided by Receiver Mycorrhizal colonization rate.
-   **ShootEnrichRatio:** Receiver 15N distribution. Receiver Shoot 15N content divided by Receiver Total 15N content.

**Random effects**

-   **IsotopeForm:** Category(5). N2, NH4, NO3, CONH2, NH4+NO3.
-   **LabelMethod:** Category(5). Fixation, Soil injection, Petiole injection or Leaf absorption.
-   **Duration:**    Category(4). Isotope Chase Time. Short term (5-10 d), Medium term (11-30 d), Long term (31-60 d), Long-long term (\> 60 d).
-   **DonSpecies:** Identity of the Donor species [phylogenetic part].
-   **RecSpecies:** Identity of the Receiver species [phylogenetic part].
-   **DonSpeciesnophylo:** Identity of the Donor species [Non-phylogenetic part].
-   **RecSpeciesnophylo:** Identity of the Receiver species [Non-phylogenetic part].


# **Load** Packages, Functions, Raw Data or Results.

```{r Load Packages and Functions}
#install.packages("MatrixModels") #for brms and ggpmisc
library(brms)                     #need rtools 
library(ggpmisc)                  #need rtools
library(ape)
library(bayesplot)
library(BayesFactor)
library(coda)
library(cowplot)
library(dplyr)
library(ggeasy)
library(ggplot2)
library(ggExtra)
library(ggpubr)
library(grid)
library(gridExtra)
library(modelr)
library(openxlsx)
library(performance)
library(phytools)
library(RColorBrewer)
library(robustbase)
library(rstan)
library(rstanarm)
library(rstantools)
library(sjPlot)
library(sjstats)
library(Taxonstand)
library(tidybayes)
library(tidyverse)
library(tidyr)
knitr::opts_chunk$set(message = F,warning = F)
removeRowsAllNa  <- function(x){x[apply(x, 1, function(y) any(!is.na(y))),]}
```

```{r Load Results}
#load('IPNT_Result.RData')
```

```{r Load Raw Data}
datasetIPNT <- read.xlsx("IPNT_Data.xlsx")
datasetIPNT <- datasetIPNT %>% filter(!is.na(Duration))

tree <- read.tree('IPNT_Tree.tre')      #Phylogenetic tree
tree <- makeNodeLabel(tree)

# Part 1 + Part 2

dataset.IPNT.NTrans        <- datasetIPNT[datasetIPNT$Ntransferred != 0,]
dataset.IPNT.NTrans        <- removeRowsAllNa(dataset.IPNT.NTrans)
don_tree1.1                <- keep.tip(tree, unique(as.character(dataset.IPNT.NTrans$DonSpecies))) %>% vcv.phylo   #Cutting branches
rec_tree1.1                <- keep.tip(tree, unique(as.character(dataset.IPNT.NTrans$RecSpecies))) %>% vcv.phylo

dataset.IPNT.TransR        <- datasetIPNT[datasetIPNT$TransferRatio != 0,]
dataset.IPNT.TransR        <- removeRowsAllNa(dataset.IPNT.TransR)
don_tree1.2                <- keep.tip(tree, unique(as.character(dataset.IPNT.TransR$DonSpecies))) %>% vcv.phylo       
rec_tree1.2                <- keep.tip(tree, unique(as.character(dataset.IPNT.TransR$RecSpecies))) %>% vcv.phylo

dataset.IPNT.NDFT          <- datasetIPNT[datasetIPNT$NDFT != 0,]
dataset.IPNT.NDFT          <- removeRowsAllNa(dataset.IPNT.NDFT)
don_tree1.3                <- keep.tip(tree, unique(as.character(dataset.IPNT.NDFT$DonSpecies))) %>% vcv.phylo
rec_tree1.3                <- keep.tip(tree, unique(as.character(dataset.IPNT.NDFT$RecSpecies))) %>% vcv.phylo

#dataset.IPNT.NTrans.Sens   <- dataset.IPNT.NTrans[dataset.IPNT.NTrans$Obs. != 5,]
#dataset.IPNT.NTrans.Sens   <- removeRowsAllNa(dataset.IPNT.NTrans.Sens)
#don_tree1Sens              <- keep.tip(tree, unique(as.character(dataset.IPNT.NTrans.Sens$DonSpecies))) %>% vcv.phylo
#rec_tree1Sens              <- keep.tip(tree, unique(as.character(dataset.IPNT.NTrans.Sens$RecSpecies))) %>% vcv.phylo

# Part 3

dataset.IPNT.SSTNC    <- dataset.IPNT.NTrans %>% filter(!is.na(SourceSinkTNC1))
don_tree3.1           <- keep.tip(tree, unique(as.character(dataset.IPNT.SSTNC$DonSpecies))) %>% vcv.phylo
rec_tree3.1           <- keep.tip(tree, unique(as.character(dataset.IPNT.SSTNC$RecSpecies))) %>% vcv.phylo

# Part 4

dataset.IPNT.SSTN      <- dataset.IPNT.NTrans %>% filter(!is.na(SourceSinkTN1))

dataset.IPNT.SSTNa   <- dataset.IPNT.SSTN[dataset.IPNT.SSTN$GroupTN == "a",]
don_tree4a           <- keep.tip(tree, unique(as.character(dataset.IPNT.SSTNa$DonSpecies))) %>% vcv.phylo
rec_tree4a           <- keep.tip(tree, unique(as.character(dataset.IPNT.SSTNa$RecSpecies))) %>% vcv.phylo

dataset.IPNT.SSTNb   <- dataset.IPNT.SSTN[dataset.IPNT.SSTN$GroupTN == "b",]
don_tree4b           <- keep.tip(tree, unique(as.character(dataset.IPNT.SSTNb$DonSpecies))) %>% vcv.phylo
rec_tree4b           <- keep.tip(tree, unique(as.character(dataset.IPNT.SSTNb$RecSpecies))) %>% vcv.phylo

# Part 5 (Supp)

dataset.IPNT.SS1      <- datasetIPNT %>% filter(!is.na(SourceSinkTNC1))
don_tree5.1           <- keep.tip(tree, unique(as.character(dataset.IPNT.SS1$DonSpecies))) %>% vcv.phylo
rec_tree5.1           <- keep.tip(tree, unique(as.character(dataset.IPNT.SS1$RecSpecies))) %>% vcv.phylo

dataset.IPNT.SS2      <- datasetIPNT %>% filter(!is.na(SourceSinkTN1))
don_tree5.2           <- keep.tip(tree, unique(as.character(dataset.IPNT.SS2$DonSpecies))) %>% vcv.phylo
rec_tree5.2           <- keep.tip(tree, unique(as.character(dataset.IPNT.SS2$RecSpecies))) %>% vcv.phylo

# Part 6 (Supp)
dataset.IPNT.Fate     <- dataset.IPNT.NTrans %>% filter(!is.na(ShootEnrichRatio))
don_tree6             <- keep.tip(tree, unique(as.character(dataset.IPNT.Fate$DonSpecies))) %>% vcv.phylo
rec_tree6             <- keep.tip(tree, unique(as.character(dataset.IPNT.Fate$RecSpecies))) %>% vcv.phylo

# Part 7 (Supp)
dataset.IPNT.MCR      <- dataset.IPNT.NTrans %>% filter(!is.na(K))
don_tree7             <- keep.tip(tree, unique(as.character(dataset.IPNT.MCR$DonSpecies))) %>% vcv.phylo
rec_tree7             <- keep.tip(tree, unique(as.character(dataset.IPNT.MCR$RecSpecies))) %>% vcv.phylo

```



# **Part 1**: Symbiosis on IPNT

## Supplementary Table 1

```{r Supplementary Table 1}
fit0.1  <- brm(data = dataset.IPNT.NTrans,
           log(Ntransferred)|weights(sqrt(Samplesize)) ~ Symbiosis
           + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) + (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),
           family = gaussian,
           cov_ranef = list(DonSpecies = don_tree1.1, RecSpecies = rec_tree1.1),
           control = list(adapt_delta = 0.9999, max_treedepth = 15),
           iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit0.1)
posterior_interval(fit0.1, prob = 0.9)
#Value
hypothesis(fit0.1, 'Intercept = 0')
hypothesis(fit0.1, 'SymbiosisB + Intercept = 0')
hypothesis(fit0.1, 'SymbiosisC + Intercept = 0')
hypothesis(fit0.1, 'SymbiosisD + Intercept = 0')

hypothesis(fit0.1, 'SymbiosisB + Intercept = SymbiosisC + Intercept')
hypothesis(fit0.1, 'SymbiosisB + Intercept = SymbiosisD + Intercept')
hypothesis(fit0.1, 'SymbiosisC + Intercept = SymbiosisD + Intercept')

#####
fit0.3 <-   brm(data = dataset.IPNT.NDFT,
            NDFT|weights(sqrt(Samplesize)) ~ Symbiosis
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) + (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),       
            family = Beta,
            cov_ranef = list(DonSpecies = don_tree1.3, RecSpecies = rec_tree1.3),
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit0.3)
posterior_interval(fit0.3, prob = 0.9)
#Value
hypothesis(fit0.3, 'Intercept = 0')
hypothesis(fit0.3, 'SymbiosisB + Intercept = 0')
hypothesis(fit0.3, 'SymbiosisC + Intercept = 0')
hypothesis(fit0.3, 'SymbiosisD + Intercept = 0')

hypothesis(fit0.3, 'SymbiosisB + Intercept = SymbiosisC + Intercept')
hypothesis(fit0.3, 'SymbiosisB + Intercept = SymbiosisD + Intercept')
hypothesis(fit0.3, 'SymbiosisC + Intercept = SymbiosisD + Intercept')

#####
fit0.2  <- brm(data = dataset.IPNT.TransR,
           TransferRatio|weights(sqrt(Samplesize)) ~ Symbiosis  
           + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) + (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),
           family = Beta,  # logit + log
           cov_ranef = list(DonSpecies = don_tree1.2, RecSpecies = rec_tree1.2),
           control = list(adapt_delta = 0.9999, max_treedepth = 15),
           iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit0.2)
posterior_interval(fit0.2, prob = 0.9)
#Value
hypothesis(fit0.2, 'Intercept = 0')
hypothesis(fit0.2, 'SymbiosisB + Intercept = 0')
hypothesis(fit0.2, 'SymbiosisC + Intercept = 0')
hypothesis(fit0.2, 'SymbiosisD + Intercept = 0')

hypothesis(fit0.2, 'SymbiosisB + Intercept = SymbiosisC + Intercept')
hypothesis(fit0.2, 'SymbiosisB + Intercept = SymbiosisD + Intercept')
hypothesis(fit0.2, 'SymbiosisC + Intercept = SymbiosisD + Intercept')

```

## Figure 2

```{r Figure 2}
h_design1 <- hypothesis(fit0.1, alpha = 0.05,                                #Plotting
                      hypothesis = c('Intercept = 0',
                                     'SymbiosisB + Intercept = 0',
                                     'SymbiosisC + Intercept = 0',
                                     'SymbiosisD + Intercept = 0'))

Figure2a <- (h_design1$samples) %>% 
            rownames_to_column('c') %>% 
            pivot_longer(-c, names_to = "hypo", values_to = "value") %>%
            ggplot() + 
            aes(x = value, y = factor(hypo, levels = c("H4", "H3", "H2", "H1") ) ) +
            stat_halfeye(.width = 0.95, height = 0.5) + 
            theme_bw() +
            theme(legend.position  = "none", 
                  plot.title       = element_text(size  = 8, face = "bold", hjust = 0.5), 
                  axis.text        = element_text(size  = 8, face = "bold"),
                  axis.title       = element_text(size  = 8, face = "bold"),
                  strip.text.x     = element_text(size  = 8)) + 
            labs(x = 'Ntransferred (mg) (ln-transformed)', y = '') + 
            coord_cartesian(xlim = c(-10,10))

ggsave('./Figure 2a.pdf',          height = 6, width = 7, units = "cm", Figure2a, useDingbats=FALSE)


h_design2 <- hypothesis(fit0.3, alpha = 0.05,                                #Plotting
                      hypothesis = c('Intercept = 0',
                                     'SymbiosisB + Intercept = 0',
                                     'SymbiosisC + Intercept = 0',
                                     'SymbiosisD + Intercept = 0'))

Figure2b <- (h_design2$samples) %>% 
            rownames_to_column('c') %>% 
            pivot_longer(-c, names_to = "hypo", values_to = "value") %>%
            ggplot() + 
            aes(x = value, y = factor(hypo, levels = c("H4", "H3", "H2", "H1") ) ) +
            stat_halfeye(.width = 0.95, height = 0.5) + 
            theme_bw() +
            theme(legend.position  = "none", 
                  plot.title       = element_text(size  = 8, face = "bold", hjust = 0.5), 
                  axis.text        = element_text(size  = 8, face = "bold"),
                  axis.title       = element_text(size  = 8, face = "bold"),
                  strip.text.x     = element_text(size  = 8)) + 
            labs(x = '', y = '') + 
            coord_cartesian(xlim = c(-8,6))

ggsave('./Figure 2b.pdf',          height = 6, width = 7, units = "cm", Figure2b, useDingbats=FALSE)


```



# **Part 2**: Symbiosis and PD on IPNT

## Supplementary Table 2

```{r Supplementary Table 2}
fit1.1   <-     brm(data = dataset.IPNT.NTrans,
                log(Ntransferred)|weights(sqrt(Samplesize)) # Natural log-transformed to improve Normality
                ~ Symbiosis + scale(PD) + Symbiosis:scale(PD)
                + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) +  (1|RecSpecies) + (1|DonSpeciesnophylo) +  (1|RecSpeciesnophylo),
                family = gaussian,
                cov_ranef = list(DonSpecies = don_tree1.1, RecSpecies = rec_tree1.1),
                control = list(adapt_delta = 0.9999, max_treedepth = 15),
                iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit1.1)
posterior_interval(fit1.1, prob = 0.9)
plot(conditional_effects(fit1.1), points = T)
r2_bayes(fit1.1)

#Value
hypothesis(fit1.1, 'scalePD = 0')
hypothesis(fit1.1, 'scalePD = 0', alpha = 0.92)

hypothesis(fit1.1, 'SymbiosisB:scalePD + scalePD = 0')
hypothesis(fit1.1, 'SymbiosisB:scalePD + scalePD = 0', alpha = 0.19)

hypothesis(fit1.1, 'SymbiosisC:scalePD + scalePD = 0')
hypothesis(fit1.1, 'SymbiosisC:scalePD + scalePD = 0', alpha = 0.08)

hypothesis(fit1.1, 'SymbiosisD:scalePD + scalePD = 0')
hypothesis(fit1.1, 'SymbiosisD:scalePD + scalePD = 0', alpha = 0.96)

#####
fit1.2  <- brm(data = dataset.IPNT.TransR,
           TransferRatio|weights(sqrt(Samplesize))
           ~ Symbiosis + scale(PD) + Symbiosis:scale(PD) 
           + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) +  (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),
           family = Beta,  # logit
           cov_ranef = list(DonSpecies = don_tree1.2, RecSpecies = rec_tree1.2),
           control = list(adapt_delta = 0.9999, max_treedepth = 15),
           iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit1.2)
plot(conditional_effects(fit1.2), points = T)
posterior_interval(fit1.2, prob = 0.9)
#Value
hypothesis(fit1.2, 'Intercept = 0')
hypothesis(fit1.2, 'SymbiosisB + Intercept = 0')
hypothesis(fit1.2, 'SymbiosisC + Intercept = 0')
hypothesis(fit1.2, 'SymbiosisD + Intercept = 0')

#
hypothesis(fit1.2, 'scalePD = 0')
hypothesis(fit1.2, 'scalePD = 0', alpha = 0.1)

hypothesis(fit1.2, 'SymbiosisB:scalePD + scalePD = 0')
hypothesis(fit1.2, 'SymbiosisB:scalePD + scalePD = 0', alpha = 0.1)

hypothesis(fit1.2, 'SymbiosisC:scalePD + scalePD = 0')
hypothesis(fit1.2, 'SymbiosisC:scalePD + scalePD = 0', alpha = 0.01)

hypothesis(fit1.2, 'SymbiosisD:scalePD + scalePD = 0')
hypothesis(fit1.2, 'SymbiosisD:scalePD + scalePD = 0', alpha = 0.1)

#####
fit1.3 <- brm(data = dataset.IPNT.NDFT,
            NDFT|weights(sqrt(Samplesize))
            ~ Symbiosis + scale(PD) + Symbiosis:scale(PD) 
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) +  (1|RecSpecies) + (1|DonSpeciesnophylo) +  (1|RecSpeciesnophylo),       
            family = Beta,
            cov_ranef = list(DonSpecies = don_tree1.3, RecSpecies = rec_tree1.3),
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit1.3)
posterior_interval(fit1.3, prob = 0.9)

#Value
hypothesis(fit1.3, 'Intercept = 0')
hypothesis(fit1.3, 'SymbiosisB + Intercept = 0')
hypothesis(fit1.3, 'SymbiosisC + Intercept = 0')
hypothesis(fit1.3, 'SymbiosisD + Intercept = 0')

#
hypothesis(fit1.3, 'scalePD = 0')
hypothesis(fit1.3, 'scalePD = 0', alpha = 0.95)

hypothesis(fit1.3, 'SymbiosisB:scalePD + scalePD = 0')
hypothesis(fit1.3, 'SymbiosisB:scalePD + scalePD = 0', alpha = 0.26)

hypothesis(fit1.3, 'SymbiosisC:scalePD + scalePD = 0')
hypothesis(fit1.3, 'SymbiosisC:scalePD + scalePD = 0', alpha = 0.56)

hypothesis(fit1.3, 'SymbiosisD:scalePD + scalePD = 0')
hypothesis(fit1.3, 'SymbiosisD:scalePD + scalePD = 0', alpha = 0.02)
```

## Figure 3

```{r Figure 3}
set.seed(123)
Figure3a <- dataset.IPNT.NTrans %>%
            data_grid(Symbiosis = c("A", "B","C","D"), PD = seq_range(PD, n = 100), .model = fit1.1) %>%
            add_epred_draws(fit1.1, ndraws = 400, re_formula = NA) %>%
            ggplot(aes(x = PD, y = log(Ntransferred), color = Symbiosis)) +
            geom_line(aes(y = .epred, group = paste(Symbiosis, .draw)), alpha = 0.05, linewidth = 0.1) +
            stat_lineribbon(aes(y = .epred, group = Symbiosis), .width = 0) +
            theme(panel.grid       = element_blank(), 
                  panel.background = element_rect(color = 'black', fill = 'transparent'),
                  legend.position  = "none", 
                  plot.title       = element_text(size  = 8, face = "bold", hjust = 0.5), 
                  axis.text        = element_text(size  = 8, face = "bold"),
                  axis.title       = element_text(size  = 8, face = "bold"),
                  strip.text.x     = element_text(size  = 8)) +
            labs(x = 'Phylogenetic distances between D and R', 
                 y = 'N amount transferred from D to R') +  
            scale_colour_manual(values=c("#696969", "#11A579", "#F2B701", "#7B68EE")) +
            coord_cartesian(ylim = c(-10,10))

Figure3a
ggsave('./Figure 3a.pdf',          height = 6, width = 8, units = "cm", Figure3a, useDingbats=FALSE)

Figure3b <- dataset.IPNT.NDFT %>%
            data_grid(Symbiosis = c("A", "B","C","D"), PD = seq_range(PD, n = 100), .model = fit1.3) %>%
            add_epred_draws(fit1.3, ndraws = 400, re_formula = NA) %>%
            ggplot(aes(x = PD, y = NDFT, color = Symbiosis)) +
            geom_line(aes(y = .epred,       group = paste(Symbiosis, .draw)), alpha = 0.05, linewidth = 0.1) +
            stat_lineribbon(aes(y = .epred, group = Symbiosis), .width = 0) +
            theme(panel.grid       = element_blank(), 
                  panel.background = element_rect(color = 'black', fill = 'transparent'),
                  legend.position  = "none", 
                  plot.title       = element_text(size  = 8, face = "bold", hjust = 0.5), 
                  axis.text        = element_text(size  = 8, face = "bold"),
                  axis.title       = element_text(size  = 8, face = "bold"),
                  strip.text.x     = element_text(size  = 8)) +
            labs(x = 'Phylogenetic distances between D and R (Myr)', 
                 y = 'Ndft ratio') +  
            scale_colour_manual(values=c("#696969", "#11A579", "#F2B701", "#7B68EE"))
Figure3b

ggsave('./Figure 3b.pdf',      height = 6, width = 8, units = "cm", Figure3b, useDingbats=FALSE)
```



# **Part 3**: Symbiosis and N pool diff on IPNT

## Supplementary Table 3

```{r Supplementary Table 3}
fit4.1a <-  brm(data = dataset.IPNT.SSTNa,
            log(Ntransferred)|weights(sqrt(Samplesize)) ~ Symbiosis + log(SourceSinkTN1) + Symbiosis:log(SourceSinkTN1)
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) + (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),
            family = gaussian,
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            cov_ranef = list(DonSpecies = don_tree4a, RecSpecies = rec_tree4a),
            iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit4.1a)
posterior_interval(fit4.1a, prob = 0.9)
plot(conditional_effects(fit4.1a), points = T)
r2_bayes(fit4.1a)
#Value
hypothesis(fit4.1a, 'logSourceSinkTN1 = 0')
hypothesis(fit4.1a, 'logSourceSinkTN1 = 0', alpha = 0.11)

hypothesis(fit4.1a, 'SymbiosisB:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.1a, 'SymbiosisB:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.23)

hypothesis(fit4.1a, 'SymbiosisC:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.1a, 'SymbiosisC:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.16)

hypothesis(fit4.1a, 'SymbiosisD:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.1a, 'SymbiosisD:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.67)

#####
fit4.2a <-  brm(data = dataset.IPNT.SSTNa,
            TransferRatio|weights(sqrt(Samplesize)) ~ Symbiosis + log(SourceSinkTN1) + Symbiosis:log(SourceSinkTN1)
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) + (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),
            family = Beta,
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            cov_ranef = list(DonSpecies = don_tree4a, RecSpecies = rec_tree4a),
            iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit4.2a)
posterior_interval(fit4.2a, prob = 0.9)

#Value
hypothesis(fit4.2a, 'logSourceSinkTN1 = 0')
hypothesis(fit4.2a, 'logSourceSinkTN1 = 0', alpha = 0.1)

hypothesis(fit4.2a, 'SymbiosisB:logSourceSinkTN1 + logSourceSinkTN1 = 0')

hypothesis(fit4.2a, 'SymbiosisC:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.2a, 'SymbiosisC:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.1)

hypothesis(fit4.2a, 'SymbiosisD:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.2a, 'SymbiosisD:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.1)

#####
fit4.3a <-  brm(data = dataset.IPNT.SSTNa,
            NDFT|weights(sqrt(Samplesize)) ~ Symbiosis + log(SourceSinkTN1) + Symbiosis:log(SourceSinkTN1)
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) + (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),
            family = Beta,
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            cov_ranef = list(DonSpecies = don_tree4a, RecSpecies = rec_tree4a),
            iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit4.3a)
posterior_interval(fit4.3a, prob = 0.9)

#Value
hypothesis(fit4.3a, 'logSourceSinkTN1 = 0')
hypothesis(fit4.3a, 'logSourceSinkTN1 = 0', alpha = 0.99)

hypothesis(fit4.3a, 'SymbiosisB:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.3a, 'SymbiosisB:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.76)

hypothesis(fit4.3a, 'SymbiosisC:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.3a, 'SymbiosisC:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.87)

hypothesis(fit4.3a, 'SymbiosisD:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.3a, 'SymbiosisD:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.01)
```

## Figure 4ac

```{r Figure 4ac}
Figure5a <- dataset.IPNT.SSTNa %>%
            data_grid(Symbiosis = c("A", "B","C","D"), SourceSinkTN1 = seq_range(SourceSinkTN1, n = 100), .model = fit4.1a) %>%
            add_epred_draws(fit4.1a, ndraws = 400, re_formula = NA) %>%
            ggplot(aes(x = log(SourceSinkTN1), y = log(Ntransferred), color = Symbiosis)) +
            geom_line(aes(y = .epred,       group = paste(Symbiosis, .draw)), alpha = 0.05, linewidth = 0.1) +
            stat_lineribbon(aes(y = .epred, group = Symbiosis), .width = 0) +
            theme(panel.grid       = element_blank(), 
                  panel.background = element_rect(color = 'black', fill = 'transparent'),
                  legend.position  = "none", 
                  plot.title       = element_text(size  = 8, face = "bold", hjust = 0.5), 
                  axis.text        = element_text(size  = 8, face = "bold"),
                  axis.title       = element_text(size  = 8, face = "bold"),
                  strip.text.x     = element_text(size  = 8)) +
            labs(x = 'DonorBiomass:ReceiverBiomass', 
                 y = 'N amount transferred from D to R') +  
            scale_colour_manual(values=c("#C0C0C0", "#11A579", "#F2B701", "#7B68EE")) +
            coord_cartesian(ylim = c(-5,5))

Figure5a

ggsave('./Figure 5a.pdf',          height = 6, width = 8, units = "cm", Figure5a, useDingbats=FALSE)

Figure5c <- dataset.IPNT.SSTNa %>%
            data_grid(Symbiosis = c("A", "B","C","D"), SourceSinkTN1 = seq_range(SourceSinkTN1, n = 100), .model = fit4.3a) %>%
            add_epred_draws(fit4.3a, ndraws = 400, re_formula = NA) %>%
            ggplot(aes(x = log(SourceSinkTN1), y = NDFT, color = Symbiosis)) +
            geom_line(aes(y = .epred,       group = paste(Symbiosis, .draw)), alpha = 0.05, linewidth = 0.1) +
            stat_lineribbon(aes(y = .epred, group = Symbiosis), .width = 0) +
            theme(panel.grid       = element_blank(), 
                  panel.background = element_rect(color = 'black', fill = 'transparent'),
                  legend.position  = "none", 
                  plot.title       = element_text(size  = 8, face = "bold", hjust = 0.5), 
                  axis.text        = element_text(size  = 8, face = "bold"),
                  axis.title       = element_text(size  = 8, face = "bold"),
                  strip.text.x     = element_text(size  = 8)) +
            labs(x = 'DonorBiomass:ReceiverBiomass', 
                 y = 'Ndft ratio') +  
            scale_colour_manual(values=c("#C0C0C0", "#11A579", "#F2B701", "#7B68EE")) +
            coord_cartesian(ylim = c(0,0.25))
Figure5c

ggsave('./Figure 5c.pdf',      height = 6, width = 8, units = "cm", Figure5c, useDingbats=FALSE)
```

## Supplementary Table 3

```{r Supplementary Table 3}
fit4.1b <-  brm(data = dataset.IPNT.SSTNb,
            log(Ntransferred)|weights(sqrt(Samplesize))
            ~ Symbiosis + log(SourceSinkTN1) + Symbiosis:log(SourceSinkTN1)
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) + (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),
            family = gaussian,
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            cov_ranef = list(DonSpecies = don_tree4b, RecSpecies = rec_tree4b),
            iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit4.1b)
posterior_interval(fit4.1b, prob = 0.9)
plot(conditional_effects(fit4.1b), points = T)
r2_bayes(fit4.1b)
#Value
hypothesis(fit4.1b, 'logSourceSinkTN1 = 0')
hypothesis(fit4.1b, 'logSourceSinkTN1 = 0', alpha = 0.99)

hypothesis(fit4.1b, 'SymbiosisB:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.1b, 'SymbiosisB:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.21)

hypothesis(fit4.1b, 'SymbiosisC:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.1b, 'SymbiosisC:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.03)

hypothesis(fit4.1b, 'SymbiosisD:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.1b, 'SymbiosisD:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.01)

#####
fit4.2b <-  brm(data = dataset.IPNT.SSTNb,
            TransferRatio|weights(sqrt(Samplesize)) ~ Symbiosis + log(SourceSinkTN1) + Symbiosis:log(SourceSinkTN1)
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) + (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),
            family = Beta,
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            cov_ranef = list(DonSpecies = don_tree4b, RecSpecies = rec_tree4b),
            iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit4.2b)
posterior_interval(fit4.2b, prob = 0.9)

#Value
hypothesis(fit4.2b, 'logSourceSinkTN1 = 0')
hypothesis(fit4.2b, 'logSourceSinkTN1 = 0', alpha = 0.1)

hypothesis(fit4.2b, 'SymbiosisB:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.2b, 'SymbiosisB:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.1)

hypothesis(fit4.2b, 'SymbiosisC:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.2b, 'SymbiosisC:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.1)

hypothesis(fit4.2b, 'SymbiosisD:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.2b, 'SymbiosisD:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.09)

#####
fit4.3b <-  brm(data = dataset.IPNT.SSTNb,
            NDFT|weights(sqrt(Samplesize)) ~ Symbiosis + log(SourceSinkTN1) + Symbiosis:log(SourceSinkTN1)
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) + (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),
            family = Beta,
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            cov_ranef = list(DonSpecies = don_tree4b, RecSpecies = rec_tree4b),
            iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit4.3b)
posterior_interval(fit4.3b, prob = 0.9)

#Value
hypothesis(fit4.3b, 'logSourceSinkTN1 = 0')
hypothesis(fit4.3b, 'logSourceSinkTN1 = 0', alpha = 0.74)

hypothesis(fit4.3b, 'SymbiosisB:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.3b, 'SymbiosisB:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.09)

hypothesis(fit4.3b, 'SymbiosisC:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.3b, 'SymbiosisC:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.01)

hypothesis(fit4.3b, 'SymbiosisD:logSourceSinkTN1 + logSourceSinkTN1 = 0')
hypothesis(fit4.3b, 'SymbiosisD:logSourceSinkTN1 + logSourceSinkTN1 = 0', alpha = 0.01)
```

## Figure 4bd

```{r Figure 4bd}
Figure5b <- dataset.IPNT.SSTNb %>%
            data_grid(Symbiosis = c("A", "B","C","D"), SourceSinkTN1 = seq_range(SourceSinkTN1, n = 100), .model = fit4.1b) %>%
            add_epred_draws(fit4.1b, ndraws = 400, re_formula = NA) %>%
            ggplot(aes(x = log(SourceSinkTN1), y = log(Ntransferred), color = Symbiosis)) +
            geom_line(aes(y = .epred,       group = paste(Symbiosis, .draw)), alpha = 0.05, linewidth = 0.1) +
            stat_lineribbon(aes(y = .epred, group = Symbiosis), .width = 0) +
            theme(panel.grid       = element_blank(), 
                  panel.background = element_rect(color = 'black', fill = 'transparent'),
                  legend.position  = "none", 
                  plot.title       = element_text(size  = 8, face = "bold", hjust = 0.5), 
                  axis.text        = element_text(size  = 8, face = "bold"),
                  axis.title       = element_text(size  = 8, face = "bold"),
                  strip.text.x     = element_text(size  = 8)) +
            labs(x = 'DonorBiomass:ReceiverBiomass', 
                 y = 'N amount transferred from D to R') +  
            scale_colour_manual(values=c("#C0C0C0", "#11A579", "#F2B701", "#7B68EE")) +
            coord_cartesian(ylim = c(-5,5))
Figure5b

ggsave('./Figure 5b.pdf',          height = 6, width = 8, units = "cm", Figure5b, useDingbats=FALSE)


Figure5d <- dataset.IPNT.SSTNb %>%
            data_grid(Symbiosis = c("A", "B","C","D"), SourceSinkTN1 = seq_range(SourceSinkTN1, n = 100), .model = fit4.3b) %>%
            add_epred_draws(fit4.3b, ndraws = 400, re_formula = NA) %>%
            ggplot(aes(x = log(SourceSinkTN1), y = NDFT, color = Symbiosis)) +
            geom_line(aes(y = .epred,       group = paste(Symbiosis, .draw)), alpha = 0.05, linewidth = 0.1) +
            stat_lineribbon(aes(y = .epred, group = Symbiosis), .width = 0) +
            theme(panel.grid       = element_blank(), 
                  panel.background = element_rect(color = 'black', fill = 'transparent'),
                  legend.position  = "none", 
                  plot.title       = element_text(size  = 8, face = "bold", hjust = 0.5), 
                  axis.text        = element_text(size  = 8, face = "bold"),
                  axis.title       = element_text(size  = 8, face = "bold"),
                  strip.text.x     = element_text(size  = 8)) +
            labs(x = 'DonorBiomass:ReceiverBiomass', 
                 y = 'Ndft ratio') +  
            scale_colour_manual(values=c("#C0C0C0", "#11A579", "#F2B701", "#7B68EE")) +
            coord_cartesian(ylim = c(0,1))
Figure5d

ggsave('./Figure 5d.pdf',      height = 6, width = 8, units = "cm", Figure5d, useDingbats=FALSE)
```



# **Part 4**: MCR

## Supplementary Table 4

```{r Supplementary Table 4}
fit7.1   <- brm(data = dataset.IPNT.MCR,
            log(Ntransferred)|weights(sqrt(Samplesize))
            ~ log(K) + NoduleExist + log(K):NoduleExist
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) +  (1|RecSpecies) + (1|DonSpeciesnophylo) +  (1|RecSpeciesnophylo),
            family = gaussian,
            cov_ranef = list(DonSpecies = don_tree7, RecSpecies = rec_tree7),
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            iter = 2000, cores = 4)
summary(fit7.1)
posterior_interval(fit7.1, prob = 0.9)

hypothesis(fit7.1, 'logK = 0')

hypothesis(fit7.1, 'logK:NoduleExistY + logK = 0')
hypothesis(fit7.1, 'logK:NoduleExistY + logK = 0', alpha=0.09)
###########
fit7.2   <- brm(data = dataset.IPNT.MCR,
            TransferRatio|weights(sqrt(Samplesize))
            ~ log(K) + NoduleExist + log(K):NoduleExist
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) +  (1|RecSpecies) + (1|DonSpeciesnophylo) +  (1|RecSpeciesnophylo),
            family = Beta,
            cov_ranef = list(DonSpecies = don_tree7, RecSpecies = rec_tree7),
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            iter = 2000, cores = 4)
summary(fit7.2)
posterior_interval(fit7.2, prob = 0.9)

hypothesis(fit7.2, 'logK = 0')
hypothesis(fit7.2, 'logK = 0', alpha=0.1)

hypothesis(fit7.2, 'logK:NoduleExistY + logK = 0')
hypothesis(fit7.2, 'logK:NoduleExistY + logK = 0', alpha=0.1)
###########
fit7.3   <- brm(data = dataset.IPNT.MCR,
            NDFT|weights(sqrt(Samplesize))
            ~ log(K) + NoduleExist + log(K):NoduleExist
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) +  (1|RecSpecies) + (1|DonSpeciesnophylo) +  (1|RecSpeciesnophylo),
            family = Beta,
            cov_ranef = list(DonSpecies = don_tree7, RecSpecies = rec_tree7),
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            iter = 2000, cores = 4)
summary(fit7.3)
posterior_interval(fit7.3, prob = 0.9)

hypothesis(fit7.3, 'logK = 0')
hypothesis(fit7.3, 'logK = 0', alpha=0.1)

hypothesis(fit7.3, 'logK:NoduleExistY + logK = 0')
hypothesis(fit7.3, 'logK:NoduleExistY + logK = 0', alpha=0.44)
```

## Figure 5

```{r Figure 5}
Figure5a <- dataset.IPNT.MCR %>%
            data_grid(NoduleExist = c("N", "Y"), K = seq_range(K, n = 100), .model = fit7.1) %>%
            add_epred_draws(fit7.1, ndraws = 400, re_formula = NA) %>%
            ggplot(aes(x = log(K), y = log(Ntransferred), color = NoduleExist)) +
            geom_line(aes(y = .epred,       group = paste(NoduleExist, .draw)), alpha = 0.05, linewidth = 0.1) +
            stat_lineribbon(aes(y = .epred, group = NoduleExist), .width = 0) +
            theme(panel.grid       = element_blank(), 
                  panel.background = element_rect(color = 'black', fill = 'transparent'),
                  legend.position  = "none", 
                  plot.title       = element_text(size  = 8, face = "bold", hjust = 0.5), 
                  axis.text        = element_text(size  = 8, face = "bold"),
                  axis.title       = element_text(size  = 8, face = "bold"),
                  strip.text.x     = element_text(size  = 8)) +
            labs(x = '', 
                 y = 'N amount transferred from D to R') +  
            scale_colour_manual(values=c("#FFA500", "#7B68EE")) +
            coord_cartesian(ylim = c(-5,5))
ggsave('./Figure 5a.pdf',          height = 6, width = 8, units = "cm", Figure5a, useDingbats=FALSE)

Figure5b <- dataset.IPNT.MCR %>%
            data_grid(NoduleExist = c("N", "Y"), K = seq_range(K, n = 100), .model = fit7.3) %>%
            add_epred_draws(fit7.3, ndraws = 400, re_formula = NA) %>%
            ggplot(aes(x = log(K), y = NDFT, color = NoduleExist)) +
            geom_line(aes(y = .epred,       group = paste(NoduleExist, .draw)), alpha = 0.05, linewidth = 0.1) +
            stat_lineribbon(aes(y = .epred, group = NoduleExist), .width = 0) +
            theme(panel.grid       = element_blank(), 
                  panel.background = element_rect(color = 'black', fill = 'transparent'),
                  legend.position  = "none", 
                  plot.title       = element_text(size  = 8, face = "bold", hjust = 0.5), 
                  axis.text        = element_text(size  = 8, face = "bold"),
                  axis.title       = element_text(size  = 8, face = "bold"),
                  strip.text.x     = element_text(size  = 8)) +
            labs(x = 'DonorBiomass:ReceiverBiomass', 
                 y = 'Ndft ratio') +  
            scale_colour_manual(values=c("#FFA500", "#7B68EE"))

ggsave('./Figure 5b.pdf',          height = 6, width = 8, units = "cm", Figure5b, useDingbats=FALSE)
```



# **Part 5 (Supplementary)**: Symbiosis and N conc diff on IPNT

## Supplementary Table 5

```{r Supplementary Table 5}
fit3.1 <-   brm(data = dataset.IPNT.SSTNC,
            log(Ntransferred)|weights(sqrt(Samplesize))
            ~ Symbiosis + log(SourceSinkTNC1) + Symbiosis:log(SourceSinkTNC1)
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) + (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),
            family = gaussian,
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            cov_ranef = list(DonSpecies = don_tree3.1, RecSpecies = rec_tree3.1),
            iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit3.1)
r2_bayes(fit3.1)
posterior_interval(fit3.1, prob = 0.9)
#plot(conditional_effects(fit3.1), points = T)

#Value
hypothesis(fit3.1, 'logSourceSinkTNC1 = 0')
hypothesis(fit3.1, 'logSourceSinkTNC1 = 0', alpha = 0.16)

hypothesis(fit3.1, 'SymbiosisB:logSourceSinkTNC1 + logSourceSinkTNC1 = 0')
hypothesis(fit3.1, 'SymbiosisB:logSourceSinkTNC1 + logSourceSinkTNC1 = 0', alpha = 0.04)

hypothesis(fit3.1, 'SymbiosisC:logSourceSinkTNC1 + logSourceSinkTNC1 = 0')
hypothesis(fit3.1, 'SymbiosisC:logSourceSinkTNC1 + logSourceSinkTNC1 = 0', alpha = 0.09)

hypothesis(fit3.1, 'SymbiosisD:logSourceSinkTNC1 + logSourceSinkTNC1 = 0')
hypothesis(fit3.1, 'SymbiosisD:logSourceSinkTNC1 + logSourceSinkTNC1 = 0', alpha = 0.14)

#####
fit3.2 <-   brm(data = dataset.IPNT.SSTNC,
            TransferRatio|weights(sqrt(Samplesize))
            ~ Symbiosis + log(SourceSinkTNC1) + Symbiosis:log(SourceSinkTNC1)
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) + (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),
            family = Beta,
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            cov_ranef = list(DonSpecies = don_tree3.1, RecSpecies = rec_tree3.1),
            iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit3.2)
posterior_interval(fit3.2, prob = 0.9)

#Value
hypothesis(fit3.2, 'logSourceSinkTNC1 = 0')
hypothesis(fit3.2, 'logSourceSinkTNC1 = 0', alpha = 0.1)

hypothesis(fit3.2, 'SymbiosisB:logSourceSinkTNC1 + logSourceSinkTNC1 = 0',alpha = 0.03)

hypothesis(fit3.2, 'SymbiosisC:logSourceSinkTNC1 + logSourceSinkTNC1 = 0',alpha = 0.01)

hypothesis(fit3.2, 'SymbiosisD:logSourceSinkTNC1 + logSourceSinkTNC1 = 0', alpha = 0.05)

#####
fit3.3 <-   brm(data = dataset.IPNT.SSTNC,
            NDFT|weights(sqrt(Samplesize))
            ~ Symbiosis + log(SourceSinkTNC1) + Symbiosis:log(SourceSinkTNC1)
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) + (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),
            family = Beta,
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            cov_ranef = list(DonSpecies = don_tree3.1, RecSpecies = rec_tree3.1),
            iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit3.3)
posterior_interval(fit3.3, prob = 0.9)

#Value
hypothesis(fit3.3, 'logSourceSinkTNC1 = 0')
hypothesis(fit3.3, 'logSourceSinkTNC1 = 0', alpha = 0.9)

hypothesis(fit3.3, 'SymbiosisB:logSourceSinkTNC1 + logSourceSinkTNC1 = 0')
hypothesis(fit3.3, 'SymbiosisB:logSourceSinkTNC1 + logSourceSinkTNC1 = 0', alpha = 0.34)

hypothesis(fit3.3, 'SymbiosisC:logSourceSinkTNC1 + logSourceSinkTNC1 = 0')
hypothesis(fit3.3, 'SymbiosisC:logSourceSinkTNC1 + logSourceSinkTNC1 = 0', alpha = 0.01)

hypothesis(fit3.3, 'SymbiosisD:logSourceSinkTNC1 + logSourceSinkTNC1 = 0')
hypothesis(fit3.3, 'SymbiosisD:logSourceSinkTNC1 + logSourceSinkTNC1 = 0', alpha = 0.01)
```

## Supplementary Figure 1

```{r Supplementary Figure 1}
Figure4a <- dataset.IPNT.SSTNC %>% 
            data_grid(Symbiosis = c("A", "B","C","D"), SourceSinkTNC1 = seq_range(SourceSinkTNC1, n = 100), .model = fit3.1) %>%
            add_epred_draws(fit3.1, ndraws = 400, re_formula = NA) %>%
            ggplot(aes(x = log(SourceSinkTNC1), y = log(Ntransferred), color = Symbiosis)) +
            geom_line(aes(y = .epred,       group = paste(Symbiosis, .draw)), alpha = 0.05, linewidth = 0.1) +
            stat_lineribbon(aes(y = .epred, group = Symbiosis), .width = 0) +
            theme(panel.grid       = element_blank(), 
                  panel.background = element_rect(color = 'black', fill = 'transparent'),
                  legend.position  = "none", 
                  plot.title       = element_text(size  = 8, face = "bold", hjust = 0.5), 
                  axis.text        = element_text(size  = 8, face = "bold"),
                  axis.title       = element_text(size  = 8, face = "bold"),
                  strip.text.x     = element_text(size  = 8)) +
            labs(x = 'DonorNconc:ReceiverNconc', 
                 y = 'N amount transferred from D to R') +  
            scale_colour_manual(values=c("#C0C0C0", "#11A579", "#F2B701", "#7B68EE")) +
            geom_vline(xintercept=0,linetype="dashed",color="grey") +
            scale_x_continuous(breaks = c(-0.5, 0, 0.5, 1, 1.5)) +
            coord_cartesian(ylim = c(-6,6))
Figure4a

ggsave('./Figure 4a.pdf',          height = 6, width = 8, units = "cm", Figure4a, useDingbats=FALSE)

Figure4b <- dataset.IPNT.SSTNC %>%
            data_grid(Symbiosis = c("A", "B","C","D"), SourceSinkTNC1 = seq_range(SourceSinkTNC1, n = 100), .model = fit3.3) %>%
            add_epred_draws(fit3.3, ndraws = 400, re_formula = NA) %>%
            ggplot(aes(x = log(SourceSinkTNC1), y = NDFT, color = Symbiosis)) +
            geom_line(aes(y = .epred,       group = paste(Symbiosis, .draw)), alpha = 0.05, linewidth = 0.1) +
            stat_lineribbon(aes(y = .epred, group = Symbiosis), .width = 0) +
            theme(panel.grid       = element_blank(), 
                  panel.background = element_rect(color = 'black', fill = 'transparent'),
                  legend.position  = "none", 
                  plot.title       = element_text(size  = 8, face = "bold", hjust = 0.5), 
                  axis.text        = element_text(size  = 8, face = "bold"),
                  axis.title       = element_text(size  = 8, face = "bold"),
                  strip.text.x     = element_text(size  = 8)) +
            labs(x = 'DonorNconc:ReceiverNconc', 
                 y = 'Ndft ratio') +  
            scale_colour_manual(values=c("#C0C0C0", "#11A579", "#F2B701", "#7B68EE")) +
            geom_vline(xintercept=0,linetype="dashed",color="grey") +
            scale_x_continuous(breaks = c(-0.5, 0, 0.5, 1, 1.5)) +
            coord_cartesian(ylim = c(0,1))
Figure4b

ggsave('./Figure 4b.pdf',      height = 6, width = 8, units = "cm", Figure4b, useDingbats=FALSE)
```



# **Part 6 (Supplementary)**

## Supplementary Table 6

```{r Supplementary Table 6}
fit5.1   <- brm(data = dataset.IPNT.SS1,
            log(SourceSinkTNC1) ~ Symbiosis
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) + (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),       
            family    = gaussian,
            cov_ranef = list(DonSpecies = don_tree5.1, RecSpecies = rec_tree5.1),
            control   = list(adapt_delta = 0.9999, max_treedepth = 15),
            iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit5.1)
posterior_interval(fit5.1, prob = 0.88)

fit5.2   <- brm(data = dataset.IPNT.SS2,
            log(SourceSinkTN1) ~ Symbiosis
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) + (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),
            family = gaussian,
            cov_ranef = list(DonSpecies = don_tree5.2, RecSpecies = rec_tree5.2),
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit5.2)
posterior_interval(fit5.2, prob = 0.9)

fit5.3   <- brm(data = dataset.IPNT.SS1,
            log(SourceSinkSize1) ~ Symbiosis
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) + (1|RecSpecies) + (1|DonSpeciesnophylo) + (1|RecSpeciesnophylo),
            family = gaussian,
            cov_ranef = list(DonSpecies = don_tree5.1, RecSpecies = rec_tree5.1),
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            iter = 2500, cores = 4)
#save.image("Result_Final.RData")
summary(fit5.3)
posterior_interval(fit5.3, prob = 0.9)
```



# **Part 7 (Supplementary)**: Receiver Shoot 15N enrichment fraction

## Supplementary Table 7

```{r Supplementary Table 7}
fit6 <-     brm(data = dataset.IPNT.Fate,
            log(ShootEnrichRatio)|weights(sqrt(Samplesize))
            ~ Mycor + log(Ntransferred) + Mycor:log(Ntransferred)
            + (1|IsotopeForm) + (1|LabelMethod) + (1|Duration) + (1|DonSpecies) +  (1|RecSpecies) + (1|DonSpeciesnophylo) +  (1|RecSpeciesnophylo),
            family = gaussian,
            cov_ranef = list(DonSpecies = don_tree6, RecSpecies = rec_tree6),
            control = list(adapt_delta = 0.9999, max_treedepth = 15),
            iter = 2000, cores = 4)
save.image("Result_Final.RData")
summary(fit6)
posterior_interval(fit6, prob = 0.15)

hypothesis(fit6, 'Intercept = 0')
hypothesis(fit6, 'MycorY  + Intercept = 0')

hypothesis(fit6, 'logNtransferred = 0', alpha = 0.01)

hypothesis(fit6, 'MycorY:logNtransferred + logNtransferred = 0', alpha = 0.01)
```

## Supplementary Figure 2

```{r Supplementary Figure 2}
FigureS2 <- dataset.IPNT.Fate %>%
            data_grid(Mycor = c("N", "Y"), Ntransferred = seq_range(Ntransferred, n = 100), .model = fit6) %>%
            add_epred_draws(fit6, ndraws = 400, re_formula = NA) %>%
            ggplot(aes(x = log(Ntransferred), y = log(ShootEnrichRatio), color = Mycor)) +
            geom_line(aes(y = .epred,       group = paste(Mycor, .draw)), alpha = 0.05, linewidth = 0.1) +
            stat_lineribbon(aes(y = .epred, group = Mycor), .width = 0) +
            theme(panel.grid       = element_blank(), 
                  panel.background = element_rect(color = 'black', fill = 'transparent'),
                  legend.position  = "none", 
                  plot.title       = element_text(size  = 8, face = "bold", hjust = 0.5), 
                  axis.text        = element_text(size  = 8, face = "bold"),
                  axis.title       = element_text(size  = 8, face = "bold"),
                  strip.text.x     = element_text(size  = 8)) +
            labs(x = 'ln (N amount transferred from D to R)', 
                 y = 'ln (Receiver Shoot 15N fraction)') +  
            scale_colour_manual(values=c("#F2B701", "#11A579")) +
            scale_fill_manual(values=alpha(c("#F2B701", "#11A579"), 0.1)) + 
            coord_cartesian(ylim = c(-4,2))
FigureS2
ggsave('Supplementary Figure 2.pdf', height = 6, width = 8, units = "cm", FigureS2, useDingbats=FALSE)
```



# **Part 8 Supplementary**: Model Checking for Bayes Mixed Effects Models

## Supplementary Figure 7

```{r Supplementary Figure 7}
color_scheme_set("gray")
#Generate data sets
bp_data0.1 <- posterior_predict(fit0.1, ndraws = 200) 
bp_data0.2 <- posterior_predict(fit0.2, ndraws = 200)
bp_data0.3 <- posterior_predict(fit0.3, ndraws = 200)

bp_data1.1  <- posterior_predict(fit1.1,  ndraws = 200) 
bp_data1.2  <- posterior_predict(fit1.2,  ndraws = 200)
bp_data1.3  <- posterior_predict(fit1.3,  ndraws = 200)

bp_data4.1a <- posterior_predict(fit4.1a, ndraws = 200) 
bp_data4.2a <- posterior_predict(fit4.2a, ndraws = 200)
bp_data4.3a <- posterior_predict(fit4.3a, ndraws = 200)

bp_data4.1b <- posterior_predict(fit4.1b, ndraws = 200) 
bp_data4.2b <- posterior_predict(fit4.2b, ndraws = 200)
bp_data4.3b <- posterior_predict(fit4.3b, ndraws = 200)

bp_data3.1 <- posterior_predict(fit3.1, ndraws = 200) 
bp_data3.2 <- posterior_predict(fit3.2, ndraws = 200)
bp_data3.3 <- posterior_predict(fit3.3, ndraws = 200)

bp_data5.1 <- posterior_predict(fit5.1, ndraws = 200)
bp_data5.2 <- posterior_predict(fit5.2, ndraws = 200)

bp_data6 <- posterior_predict(fit6, ndraws = 200)

bp_data7.1 <- posterior_predict(fit7.1, ndraws = 200) 
bp_data7.2 <- posterior_predict(fit7.2, ndraws = 200)
bp_data7.3 <- posterior_predict(fit7.3, ndraws = 200)

#Joint (all data) posterior predictive visual checks
a0.1 <- ppc_dens_overlay(y = log(dataset.IPNT.NTrans$Ntransferred), yrep = bp_data0.1) + legend_none()
a0.2 <- ppc_dens_overlay(y = dataset.IPNT.TransR$TransferRatio,     yrep = bp_data0.2) + legend_none() 
a0.3 <- ppc_dens_overlay(y = dataset.IPNT.NDFT$NDFT,                yrep = bp_data0.3) + legend_none()

a1.1  <- ppc_dens_overlay(y = log(dataset.IPNT.NTrans$Ntransferred), yrep = bp_data1.1)  + legend_none()
a1.2  <- ppc_dens_overlay(y = dataset.IPNT.TransR$TransferRatio,     yrep = bp_data1.2)  + legend_none() 
a1.3  <- ppc_dens_overlay(y = dataset.IPNT.NDFT$NDFT,                yrep = bp_data1.3)  + legend_none()

a3.1  <- ppc_dens_overlay(y = log(dataset.IPNT.SSTNC$Ntransferred), yrep = bp_data3.1)  + legend_none()
a3.2  <- ppc_dens_overlay(y = dataset.IPNT.SSTNC$TransferRatio,     yrep = bp_data3.2)  + legend_none() 
a3.3  <- ppc_dens_overlay(y = dataset.IPNT.SSTNC$NDFT,              yrep = bp_data3.3)  + legend_none()

a4.1a  <- ppc_dens_overlay(y = log(dataset.IPNT.SSTNa$Ntransferred), yrep = bp_data4.1a)  + legend_none()
a4.2a  <- ppc_dens_overlay(y = dataset.IPNT.SSTNa$TransferRatio,     yrep = bp_data4.2a)  + legend_none() 
a4.3a  <- ppc_dens_overlay(y = dataset.IPNT.SSTNa$NDFT,              yrep = bp_data4.3a)  + legend_none()

a4.1b  <- ppc_dens_overlay(y = log(dataset.IPNT.SSTNb$Ntransferred), yrep = bp_data4.1b)  + legend_none()
a4.2b  <- ppc_dens_overlay(y = dataset.IPNT.SSTNb$TransferRatio,     yrep = bp_data4.2b)  + legend_none() 
a4.3b  <- ppc_dens_overlay(y = dataset.IPNT.SSTNb$NDFT,              yrep = bp_data4.3b)  + legend_none()

a5.1  <- ppc_dens_overlay(y = log(dataset.IPNT.SS1$SourceSinkTNC1),  yrep = bp_data5.1) + legend_none()
a5.2  <- ppc_dens_overlay(y = log(dataset.IPNT.SS2$SourceSinkTN1),   yrep = bp_data5.2) + legend_none()

a6  <- ppc_dens_overlay(y = log(dataset.IPNT.Fate$ShootEnrichRatio),  yrep = bp_data6) + legend_none()

a7.1  <- ppc_dens_overlay(y = log(dataset.IPNT.MCR$Ntransferred), yrep = bp_data7.1)  + legend_none()
a7.2  <- ppc_dens_overlay(y = dataset.IPNT.MCR$TransferRatio,     yrep = bp_data7.2)  + legend_none() 
a7.3  <- ppc_dens_overlay(y = dataset.IPNT.MCR$NDFT,              yrep = bp_data7.3)  + legend_none()

Modelchecking <- cowplot::plot_grid(a0.1, a0.2, a0.3,
                                    a1.1, a1.2, a1.3,
                                    a3.1, a3.2, a3.3,
                                    a4.1a, a4.2a, a4.3a,
                                    a4.1b, a4.2b, a4.3b,
                                    a5.1, a5.2, a6, 
                                    a7.1, a7.2, a7.3,
                                    ncol = 3, nrow = 7)

ggsave('./Supplementary Figure 7.pdf', height = 15, width = 9, units = "cm", Modelchecking, useDingbats=FALSE)
```